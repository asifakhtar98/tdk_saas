# Epic 2 Retrospective - Authentication & Organization

**Date:** 2026-02-16
**Epic:** 2 - Authentication & Organization
**Status:** ‚úÖ Completed
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Asak (Project Lead)

---

## Epic Summary

Epic 2 built the secure multi-tenancy foundation for TKD Brackets, delivering:

- **10/10 stories completed** (100% completion rate)
- **207+ new unit tests** (Total: 544+)
- **Zero analyzer errors** maintained throughout
- **Full Auth & Organization System** implemented

### Stories Delivered

1. Auth Feature Structure & Domain Layer
2. User Entity & Repository
3. Email Magic Link Sign-Up
4. Email Magic Link Sign-In
5. Auth State Management (AuthenticationBloc)
6. Organization Entity & Repository
7. Create Organization Use Case
8. Invitation Entity & Send Invite
9. RBAC Permission Service
10. Demo-to-Production Migration

---

## Successes & Strengths

### üèÜ Major Wins

1.  **Architecture Pattern Replication**
    *   The pattern established in `UserEntity`/`UserRepository` was successfully replicated for `Organization` and `Invitation`.
    *   This consistency accelerated development for later stories (2.6, 2.8).

2.  **Robust Security Implementation**
    *   **RBAC:** Granular permissions implemented with a static matrix, covering all 4 roles (Owner, Admin, Scorer, Viewer).
    *   **Auth Checks:** Consistent security checks in use cases (verifying user identity before allowed actions).
    *   **Offline-First:** Repositories correctly prioritize local cache while syncing with Supabase.

3.  **Code Review Effectiveness**
    *   Caught critical logic bugs (e.g., "Double Increment" bug in `OrganizationRepository`).
    *   Identified and fixed orphaned generated files (Story 2.8).
    *   Enforced naming conventions (snake_case for JSON).

4.  **Testing Coverage**
    *   RBAC service achieved 100% matrix coverage.
    *   Repository tests cover offline/online scenarios using `mocktail`.
    *   Use case tests verify negative scenarios (auth mismatch, org mismatch).

5.  **Seamless State Management**
    *   `AuthenticationBloc` successfully bridges the gap between Supabase auth events and app-wide state.
    *   `freezed` events and states provide type safety and boilerplate reduction.

---

## Challenges & Growth Areas

### ‚ö†Ô∏è Key Challenges

1.  **Sync Versioning Complexity ("Double Increment Bug")**
    *   **Issue:** `AppDatabase` increments `sync_version` inside a transaction, but the Repository was also attempting to increment it or send a default value.
    *   **Resolution:** Clarified that Repository should read the *existing* version, and let the Database handle the increment logic during the update.
    *   **Lesson:** Database transaction logic is the source of truth for versioning.

2.  **Generated Files Management**
    *   **Issue:** Orphaned `.freezed.dart` and `.g.dart` files from aborted/renamed classes caused build confusion in Story 2.8.
    *   **Resolution:** Manual cleanup required.
    *   **Lesson:** Must run `build_runner build --delete-conflicting-outputs` and manually verify invalidations when renaming files.

3.  **JSON Naming Consistency**
    *   **Issue:** Initial attempt in Story 2.8 used `camelCase` for JSON keys, conflicting with the Supabase `snake_case` convention.
    *   **Resolution:** Caught in code review and fixed with `@JsonKey(name: 'snake_case')`.
    *   **Lesson:** Enforce snake_case for all remote data models early.

4.  **Logic Gaps in Use Cases**
    *   **Issue:** Initial RBAC use cases missed checks for cross-organization attacks (Owner A removing User B from Org C).
    *   **Resolution:** Added explicit organization ID matching in `UpdateUserRole` and `RemoveOrganizationMember`.

---

## Technical Debt

### üìã Deferred Items

| Item                         | Location                | Priority | Deferred To                               |
| ---------------------------- | ----------------------- | -------- | ----------------------------------------- |
| Invitation UI                | Presentation Layer      | High     | Future Story (Epic 2 extension or Epic 7) |
| Accept Invite UI             | Presentation Layer      | High     | Future Story                              |
| Edge Functions deployment    | Infrastructure          | Medium   | Deployment Phase                          |
| Strict Linter Rules for JSON | `analysis_options.yaml` | Low      | Maintenance                               |

### üîß Minor Debt

-   `AuthenticationBloc` structure test needs to be updated.
-   Some integration tests rely on mocks; real e2e tests needed for complex auth flows.

---

## Key Insights & Learnings

### üí° Technical Learnings

1.  **Static Logic for Permissions:** `RbacPermissionService` works best as a simple, stateless domain service with a `static const` matrix. No need for complex state.
2.  **`fold` Chaining:** For multi-step use cases (e.g. Create Org -> Update User), chaining `fold` callbacks is effective but deep nesting can reduce readability. Future consideration: `Do` notation or helper functions.
3.  **Unit vs. LazySingleton:** Use cases must be `@injectable` (transient), while Repos/Services are `@lazySingleton`. Mixing this up causes state leakage (caught in Story 2.7).

### üìä Process Learnings

1.  **Code Review is Critical:** The adverse review process caught bugs that would have been disastrous in production (security holes, data sync bugs).
2.  **Clean Up as You Go:** Orphaned files accumulate quickly with code generation. Weekly/Epic-end cleanup is necessary.

---

## Velocity Patterns

### üìà Smooth Stories

| Story                   | Why Smooth                                      |
| ----------------------- | ----------------------------------------------- |
| 2.1 - 2.4 Auth Basics   | Well-defined patterns, standard implementation  |
| 2.7 Create Org Use Case | Clear validation rules, leveraged existing repo |
| 2.10 Demo Migration     | Isolated logic, clear input/output              |

### üìâ Struggled Stories

| Story               | Challenges                           | Resolution                      |
| ------------------- | ------------------------------------ | ------------------------------- |
| 2.6 Org Entity/Repo | Sync versioning logic                | "H3 Fix" in code review         |
| 2.8 Invitation      | Naming conventions, orphaned files   | Strict cleanup and review       |
| 2.9 RBAC            | Missing logic for cross-org security | Added specific validation steps |

---

## Action Items

### ‚úÖ Process Improvements

1.  **Strict Cleanup Protocol**
    *   **Owner:** All Developers
    *   **Action:** When deleting/renaming a file, immediately delete its generated counterparts (`.g.dart`, `.freezed.dart`).

2.  **JSON Naming Standard**
    *   **Owner:** Tech Lead
    *   **Action:** Add explicit rule: "All Network Models must use `snake_case` keys."

3.  **Security Checklist Update**
    *   **Owner:** Security Lead / Architect
    *   **Action:** Add "Cross-Organization Check" to the standard Use Case checklist.

### üìù Documentation

4.  **Sync Versioning Guide**
    *   **Owner:** Senior Dev
    *   **Action:** Document the "Database handles increment" pattern in `architecture.md`.

---

## Epic 3 Preparation

### üöÄ Preparation Tasks

**Technical Setup:**
- [ ] Review `Organization` and `User` patterns for applicability to `Tournament` (Story 3.1).
- [ ] Design the "Smart Division Builder" algorithm inputs/outputs (Story 3.8 preview).

**Knowledge Development:**
- [ ] Research efficient tree/graph structures for Bracket generation (Epic 5 prep, but affects Epic 3 data structures).

### ‚ö†Ô∏è Critical Path

**Blockers to Resolve Before Epic 3:**
1.  **Tournament Schema Finalization:** Ensure `tournaments` table schema in `architecture.md` supports the complex division logic.

---

## Readiness Assessment

| Dimension           | Status   | Notes                                         |
| ------------------- | -------- | --------------------------------------------- |
| Testing & Quality   | ‚úÖ Strong | 544+ tests, robust coverage                   |
| Deployment          | üü° TBD    | Pending Edge Functions & Web Deployment setup |
| Technical Health    | ‚úÖ Stable | Patterns held up well under complexity        |
| Unresolved Blockers | ‚úÖ None   | All Epic 2 stories complete                   |

---

## Next Steps

1.  **Review this retrospective**.
2.  **Update Sprint Status** (Mark Epic 2 as Done).
3.  **Begin Epic 3** - Tournament & Division Management.

---

*Retrospective facilitated by BMAD workflow*
*Generated: 2026-02-16*
