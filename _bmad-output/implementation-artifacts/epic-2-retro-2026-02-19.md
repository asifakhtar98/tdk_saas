# Epic 2 Retrospective ‚Äî Authentication & Organization (Revised)

**Date:** 2026-02-19
**Epic:** 2 ‚Äî Authentication & Organization
**Status:** ‚úÖ Completed (re-evaluated with Epic 3 hindsight)
**Facilitator:** Bob (Scrum Master)
**Participants:** Alice (Product Owner), Charlie (Senior Dev), Dana (QA Engineer), Elena (Junior Dev), Asak (Project Lead)

---

## Epic Summary

Epic 2 built the secure multi-tenancy foundation for TKD Brackets ‚Äî the authentication, organization management, invitation system, RBAC, and demo-to-production migration. This retrospective is a **second pass** with the benefit of hindsight from Epic 3 (Tournament & Division Management), which is now nearly complete.

### Key Metrics

| Metric                   | Value                                                           |
| ------------------------ | --------------------------------------------------------------- |
| Stories Completed        | **10/10** (100%)                                                |
| Cumulative Tests at End  | **544+** unit tests                                             |
| New Tests Added          | **~270** across all stories                                     |
| Code Review Rounds       | **5 stories** received Senior Developer Review                  |
| Agent Models Used        | **3 different** (Antigravity, minimax/m2.5, opencode/kimi-k2.5) |
| `flutter analyze` Errors | **0** maintained throughout                                     |

### Stories Delivered

| #    | Story                                 | Key Deliverable                                                                                                    |
| ---- | ------------------------------------- | ------------------------------------------------------------------------------------------------------------------ |
| 2.1  | Auth Feature Structure & Domain Layer | Clean Architecture directories, `UseCase<T, Params>` base class                                                    |
| 2.2  | User Entity & Repository              | `UserEntity`, offline-first `UserRepositoryImplementation`, 49 tests                                               |
| 2.3  | Email Magic Link Sign-Up              | `SupabaseAuthDatasource`, auth failure hierarchy, `SignUpWithEmailUseCase`                                         |
| 2.4  | Email Magic Link Sign-In              | `verifyMagicLinkOtp`, `authStateChanges` stream, `AuthRepositoryImplementation`                                    |
| 2.5  | Auth State Management                 | `AuthenticationBloc`, `GoRouterRefreshStream`, router redirect guard                                               |
| 2.6  | Organization Entity & Repository      | `OrganizationEntity`, `OrganizationModel` with full conversion methods, 69 tests                                   |
| 2.7  | Create Organization Use Case          | UUID generation, slug generation, free-tier defaults, user‚Üíowner promotion                                         |
| 2.8  | Invitation Entity & Send Invite       | `InvitationEntity`, `SendInvitationUseCase`, `AcceptInvitationUseCase`, DB schema v4                               |
| 2.9  | RBAC Permission Service               | `Permission` enum (17 values), `RbacPermissionService`, `UpdateUserRoleUseCase`, `RemoveOrganizationMemberUseCase` |
| 2.10 | Demo-to-Production Migration          | `DemoMigrationService`, UUID remapping, atomic transaction, `MigrateDemoDataUseCase`                               |

---

## Successes & Strengths

### üèÜ Major Wins

1. **Architecture Pattern Replication at Scale**
   - The `Entity ‚Üí Model ‚Üí Datasource ‚Üí Repository ‚Üí Use Case` pattern established in Story 2.2 was successfully replicated for Organization (2.6), Invitation (2.8), and then heavily reused in Epic 3 for `Tournament` and `Division`.
   - **Hindsight validation:** Epic 3 developers cited `organization_model.dart` and `user_repository_implementation.dart` as direct pattern references in every single story's Dev Notes. The pattern held.
   - The `fromDriftEntry()`, `fromJson()`, `toJson()`, `toDriftCompanion()`, `convertToEntity()`, `convertFromEntity()` conversion method set became the gold standard.

2. **Security-First Design**
   - Authentication checks were baked into *every* use case that modifies data (2.7, 2.8, 2.9).
   - Code review caught and added cross-organization attack prevention (Story 2.9).
   - The pattern of `AuthRepository.getCurrentAuthenticatedUser()` ‚Üí verify match ‚Üí proceed became the template for Epic 3 use cases.

3. **Robust Code Review Process**
   - **5 formal reviews** across the epic caught critical bugs:
     - **Double Increment Bug** (Story 2.6): Repository was sending default `syncVersion: 1` to remote, fixed to read existing and increment.
     - **Orphaned Organization Bug** (Story 2.7): Added `ErrorReportingService` logging when user update fails after org creation.
     - **Demo Cleanup Bug** (Story 2.10): `_cleanupDemoUsers()` called after ID remapping, so it couldn't find users. Reordered.
     - **Cross-Org Attack Vector** (Story 2.9): Missing organization ID match validation.
   - Reviews also improved code quality: cascade operators, const constructors, raw string cleanup, import ordering.

4. **Offline-First Consistency**
   - Every repository follows the same read/write pattern:
     - **Read:** Local first ‚Üí remote fallback (if online)
     - **Write:** Local first ‚Üí sync to remote (swallowed failure on remote)
   - `ConnectivityService` injection provides clean testability.

5. **Comprehensive Failure Hierarchy**
   - Built up from `Failure` base class through:
     - `InputValidationFailure` (with `fieldErrors` map)
     - `AuthenticationFailure`
     - `AuthorizationPermissionDeniedFailure`
     - `LocalCacheAccessFailure`, `LocalCacheWriteFailure`
     - `InvalidEmailFailure`, `RateLimitExceededFailure`, `MagicLinkSendFailure`
     - `DemoMigrationFailure` (with enum reasons)
   - **Hindsight:** This hierarchy was extended in Epic 3 exactly once (adding tournament-specific failures), proving it was well-designed from the start.

---

## Challenges & Growth Areas

### ‚ö†Ô∏è Key Challenges

1. **Sync Versioning Complexity ("Double Increment Bug")**
   - **Story:** 2.6 (Organization Entity & Repository)
   - **Issue:** `AppDatabase.updateOrganization()` increments `syncVersion` inside a Drift transaction. The repository was also incrementing it, causing a double increment.
   - **Root Cause:** Unclear ownership of version management between layers.
   - **Resolution:** Established rule: "Database handles increment. Repository reads existing version."
   - **Prevention:** Documented in story Dev Notes as a critical warning for all future repositories.
   - **Hindsight:** Epic 3 repositories (`TournamentRepositoryImplementation`, `DivisionRepositoryImplementation`) correctly followed this pattern with explicit `// DO NOT manually increment syncVersion` comments.

2. **Generated Files Orphan Management**
   - **Story:** 2.8 (Invitation Entity)
   - **Issue:** 5 orphaned `.freezed.dart` and `.g.dart` files existed from a previous aborted implementation attempt. These caused `build_runner` conflicts.
   - **Root Cause:** Renaming/deleting source files without cleaning generated outputs.
   - **Resolution:** Manual deletion required before implementation. Story Dev Notes included explicit file list.
   - **Prevention:** Added as a "Task 0" in Story 2.8 ‚Äî now a documented pre-implementation step.

3. **JSON Naming Convention Inconsistency**
   - **Story:** 2.8
   - **Issue:** Orphaned `invitation_model.g.dart` used `camelCase` JSON keys, contradicting the `snake_case` Supabase convention.
   - **Resolution:** Used `@JsonKey(name: 'snake_case')` annotations consistently.
   - **Hindsight:** Epic 3 models all correctly used `snake_case` from the start ‚Äî lesson was learned.

4. **Multi-Agent Inconsistency**
   - **Observation:** 3 different AI agent models contributed to this epic:
     - `Antigravity` (Stories 2.1-2.6, 2.9)
     - `minimax/minimax-m2.5` (Story 2.7)
     - `opencode/kimi-k2.5-free` (Story 2.10)
   - **Issue:** Code style and thoroughness varied. Story 2.10 was initially implementation-complete but lacked the unit tests it claimed, requiring a follow-up review to create them.
   - **Lesson:** Code review is non-negotiable regardless of agent. Different agents have different strengths ‚Äî Antigravity was strongest on architecture compliance, minimax on implementation speed.

5. **Deeply Nested `fold` Chains**
   - **Stories:** 2.7, 2.8, 2.9
   - **Issue:** Multi-step use cases (e.g., auth check ‚Üí validate ‚Üí create org ‚Üí update user) result in 3-4 levels of nested `fold` callbacks, making code hard to read.
   - **Resolution:** Accepted as a known limitation of fpdart's `Either` pattern. Considered `Do` notation but decided against premature abstraction.
   - **Hindsight:** Epic 3 use cases show the same pattern, confirming it's manageable but not ideal. Worth revisiting if use cases grow beyond 4 steps.

6. **Demo Migration Service Integration Test Limitations**
   - **Story:** 2.10
   - **Issue:** `DemoMigrationService` integration tests had SQLite FK constraint issues in the test environment. Only 19 out of 34+ tests ran reliably.
   - **Root Cause:** In-memory Drift databases don't enforce FK constraints the same way as production SQLite.
   - **Resolution:** Core logic verified via use case tests (mocked service). Service-level tests marked with caveats.
   - **Status:** Still outstanding. Not blocking, but should be addressed.

---

## Technical Debt

### üìã Deferred Items

| Item                                         | Location                            | Priority | Notes                                        |
| -------------------------------------------- | ----------------------------------- | -------- | -------------------------------------------- |
| Invitation UI (send/accept)                  | Presentation Layer                  | High     | No BLoC/screens yet                          |
| Auth UI (sign-in/sign-up forms)              | Presentation Layer                  | High     | No BLoC/screens yet                          |
| Edge Function deployment (`send-invitation`) | Infrastructure/Supabase             | Medium   | Server-side email sending                    |
| E2E auth flow tests                          | Testing                             | Medium   | Only unit/mock tests exist                   |
| DemoMigrationService FK test fix             | Testing                             | Medium   | SQLite FK constraint issues                  |
| Incomplete idempotency check in migration    | `demo_migration_service.dart`       | Low      | Only checks orgs table, not all entity types |
| Migration failure silently ignored in signup | `create_organization_use_case.dart` | Low      | By design, but could leave partial state     |
| `fold` chain readability                     | All multi-step use cases            | Low      | Consider `Do` notation in future             |

### üîß Minor Debt from Code Reviews

- Story 2.7: 10 info-level lint issues fixed in second review pass (import ordering, const usage)
- Story 2.9: Rogue `lib/` directory at project root deleted
- Story 2.10: 2 line-length warnings remain in existing code

---

## Key Insights & Learnings

### üí° Technical Learnings

1. **"Database Handles Increment" Rule**
   - Drift transactions own `syncVersion` management. Repository layer must *read* the version, not *compute* it.
   - This rule has been validated across 5 repositories (User, Organization, Tournament, Division, Participant).

2. **Static Permission Matrix > Dynamic RBAC**
   - `RbacPermissionService` uses a `static const Map<UserRole, Set<Permission>>` ‚Äî simple, testable, zero runtime overhead.
   - Owner uses `Permission.values` spread, making it automatically inherit any future permissions.
   - **Hindsight:** Epic 3 use cases call `RbacPermissionService.assertPermission()` and `canPerform()` exactly as designed.

3. **`BlocProvider.value` for DI-Managed Singletons**
   - `AuthenticationBloc` is `@LazySingleton`, managed by GetIt. Using `BlocProvider(create:)` would create a separate instance.
   - Must use `BlocProvider.value(value: getIt<AuthenticationBloc>())` to share the same instance.
   - `GoRouterRefreshStream` bridges BLoC stream ‚Üí `ChangeNotifier` for router redirect listening.

4. **Model Conversion Method Set is the Gold Standard**
   - Every model must implement: `fromDriftEntry()`, `fromJson()`, `toJson()`, `toDriftCompanion()`, `convertToEntity()`, `convertFromEntity()`
   - This was established in Story 2.2 and has been replicated in every subsequent model across Epic 2 and Epic 3.

5. **`@injectable` for Use Cases, `@LazySingleton` for Services/Repos**
   - Use cases are transient (new instance per invocation).
   - Services and repositories are singletons (shared state/connection).
   - Mixing this up causes state leakage. Caught in Story 2.7 review.

6. **Auth Check Pattern is Template**
   - Every privileged use case starts with:
     ```dart
     final authResult = await _authRepository.getCurrentAuthenticatedUser();
     return authResult.fold(Left.new, (authUser) async {
       if (authUser.id != params.userId) {
         return const Left(AuthenticationFailure(...));
       }
       // proceed...
     });
     ```
   - This exact pattern was replicated in Stories 2.7, 2.8, 2.9 and then in Epic 3.

### üìä Process Learnings

1. **Code Review Catches What Tests Don't**
   - The sync version bug, cross-org attack vector, and demo cleanup ordering were all logic errors that unit tests wouldn't catch because the tests were mocking the same incorrect assumptions.
   - **Action:** Adversarial code review must continue for every story.

2. **Story Dev Notes Are Documentation Gold**
   - Every story includes comprehensive Dev Notes with critical implementation notes, pattern references, and warnings.
   - **Hindsight:** Epic 3 stories reference Epic 2 Dev Notes directly. This cross-epic knowledge transfer is working.

3. **Multiple Agent Models Require Verification**
   - Different agents produce different quality levels. Story 2.10 initially claimed tests existed that didn't.
   - **Action:** Always verify test file existence and run the suite before marking tasks complete.

---

## Velocity Patterns

### üìà Smooth Stories

| Story                        | Why Smooth                                     | Pattern Impact                       |
| ---------------------------- | ---------------------------------------------- | ------------------------------------ |
| 2.1 Auth Structure           | Pure scaffolding, well-defined                 | Set directory conventions for epic   |
| 2.2 User Entity & Repository | First implementation, established all patterns | Referenced by every subsequent story |
| 2.3 Sign-Up                  | Clear Supabase API, isolated datasource        | Clean separation of concerns         |
| 2.5 AuthBloc                 | BLoC pattern well-known, clear events/states   | `GoRouterRefreshStream` was reusable |
| 2.7 Create Organization      | Leveraged existing repos, clear AC             | Slug generation was well-spec'd      |

### üìâ Struggled Stories

| Story               | Challenge                                    | Root Cause                   | Fix                                      |
| ------------------- | -------------------------------------------- | ---------------------------- | ---------------------------------------- |
| 2.6 Org Repository  | Double increment bug                         | Layer responsibility unclear | "DB handles increment" rule              |
| 2.8 Invitation      | Orphaned files, naming                       | Previous aborted attempt     | Manual cleanup, JSON convention          |
| 2.9 RBAC            | Missing cross-org checks                     | Incomplete security analysis | Added org ID validation                  |
| 2.10 Demo Migration | Test environment FK issues, cleanup ordering | SQLite test limitations      | Reordered operations, accepted test gaps |

### üìä Agent Velocity Comparison

| Agent              | Stories      | Observations                                          |
| ------------------ | ------------ | ----------------------------------------------------- |
| Antigravity        | 2.1-2.6, 2.9 | Strongest architecture compliance, thorough Dev Notes |
| minimax/m2.5       | 2.7          | Fast implementation, 20+ tests in one session         |
| opencode/kimi-k2.5 | 2.10         | Good implementation but missing tests initially       |

---

## Previous Retrospective Follow-Through

### Epic 1 ‚Üí Epic 2 Action Items

| Epic 1 Action Item                    | Status            | Evidence                                                 |
| ------------------------------------- | ----------------- | -------------------------------------------------------- |
| Establish Clean Architecture patterns | ‚úÖ Carried forward | All stories follow entity‚Üímodel‚Üídatasource‚Üírepo‚Üíuse case |
| Consistent testing patterns           | ‚úÖ Carried forward | `mocktail` used consistently, `setUpAll` for fallbacks   |
| Feature documentation                 | ‚úÖ Implemented     | `auth/README.md` created in Story 2.1                    |
| Analysis options for linting          | ‚úÖ Applied         | `analysis_options.yaml` enforced across all stories      |

---

## Epic 3 Preparation Assessment (Hindsight)

### How Well Did Epic 2 Prepare for Epic 3?

**Answer: Very well.** Epic 3 was able to:

1. ‚úÖ **Direct pattern replication** ‚Äî Tournament and Division entities, models, datasources, and repositories all followed the Epic 2 blueprint with zero architectural divergence.
2. ‚úÖ **RBAC integration** ‚Äî Epic 3 use cases use `RbacPermissionService.assertPermission()` to enforce tournament management permissions.
3. ‚úÖ **Auth check template** ‚Äî Every Epic 3 use case starts with the same auth verification pattern.
4. ‚úÖ **Failure hierarchy extension** ‚Äî Only needed to add one new failure type (`DivisionTemplateNotFoundFailure`), validating the original hierarchy design.
5. ‚ö†Ô∏è **DI registration** ‚Äî One Epic 3 story hit a `GetIt` registration error for `DivisionTemplateRepository` because the `@LazySingleton` annotation was missing. This was a one-off fix but suggests better DI verification tooling would help.

### What Could Have Been Better

1. **Sync strategy documentation** ‚Äî While the "DB handles increment" rule was documented in story Dev Notes, it wasn't in `architecture.md`. Epic 3 developers had to find it by reading Epic 2 stories.
2. **ConnectivityService pattern** ‚Äî This service is injected everywhere but has no integration tests. It's entirely mocked.
3. **Presentation layer gap** ‚Äî Epic 2 delivered zero UI. Auth screens are still not implemented. This hasn't blocked Epic 3 (logic-first strategy), but it means the auth flow is untested end-to-end.

---

## Action Items

### ‚úÖ Process Improvements

1. **Strict Generated File Cleanup Protocol**
   - **Owner:** All Developers
   - **Action:** When deleting/renaming a source file, immediately delete `.freezed.dart`, `.g.dart`, and `.config.dart` counterparts.
   - **Verification:** Run `build_runner` with `--delete-conflicting-outputs` after any file rename.

2. **JSON Naming Convention Enforcement**
   - **Owner:** Architect
   - **Action:** All remote data models must use `@JsonKey(name: 'snake_case')`. Add to `architecture.md` conventions.
   - **Status:** ‚úÖ Already followed in Epic 3 ‚Äî formalize in documentation.

3. **Security Checklist for Use Cases**
   - **Owner:** Security Lead
   - **Action:** Every privileged use case must include:
     - [ ] Auth user verification
     - [ ] Organization membership check
     - [ ] Cross-organization attack prevention
     - [ ] Role-based permission check
   - **Status:** ‚úÖ Pattern established, needs formalization in checklist.

4. **Agent Output Verification Protocol**
   - **Owner:** Project Lead
   - **Action:** When using any AI agent, always:
     - [ ] Run `flutter test` to verify claimed tests exist and pass
     - [ ] Run `flutter analyze` to verify zero new issues
     - [ ] Verify file creation claims against filesystem
   - **Rationale:** Story 2.10 claimed tests that didn't exist.

### üìù Documentation Updates

5. **Sync Versioning Guide in `architecture.md`**
   - **Owner:** Senior Dev
   - **Action:** Document the "Database handles syncVersion increment" rule formally.
   - **Status:** Partially done (in story Dev Notes), needs migration to architecture doc.

6. **Model Conversion Pattern Reference**
   - **Owner:** Senior Dev
   - **Action:** Create a model conversion pattern reference showing the 6-method standard.
   - **Status:** Exists implicitly in `user_model.dart` ‚Äî formalize as explicit documentation.

### üîß Technical Debt Resolution

7. **DemoMigrationService FK Test Fix**
   - **Owner:** QA
   - **Action:** Investigate and resolve SQLite FK constraint issues in test environment.
   - **Priority:** Medium

8. **Migration Idempotency Enhancement**
   - **Owner:** Dev
   - **Action:** Extend `_hasProductionData()` to check all entity tables, not just organizations.
   - **Priority:** Low

---

## Readiness Assessment (Post-Epic 3 Validation)

| Dimension            | Status        | Notes                                           |
| -------------------- | ------------- | ----------------------------------------------- |
| Pattern Reusability  | ‚úÖ Exceptional | Epic 3 validated every pattern                  |
| Testing & Quality    | ‚úÖ Strong      | 544+ tests at Epic 2 end, patterns replicated   |
| RBAC Integration     | ‚úÖ Working     | Epic 3 uses `assertPermission()` correctly      |
| Security Patterns    | ‚úÖ Validated   | Auth checks replicated across epics             |
| Technical Health     | ‚úÖ Stable      | No cascading issues from Epic 2 decisions       |
| Deployment Readiness | üü° Pending     | Edge Functions, Auth UI still needed            |
| Technical Debt       | üü° Manageable  | 8 items tracked, none blocking                  |
| Sync Strategy        | ‚úÖ Validated   | Offline-first pattern works across all entities |

---

## Significant Discoveries

### Discovery 1: Multi-Agent Development Works with Guardrails

Epic 2 demonstrated that using multiple AI agents (Antigravity, minimax, kimi) is viable when:
- Strict architecture patterns are documented in story Dev Notes
- Code review catches agent-specific quality gaps
- Test verification is mandatory (not trusting claimed completions)

### Discovery 2: Epic 2 Patterns Are the Foundation for All Future Epics

The patterns established in Epic 2 (entity lifecycle, repository pattern, use case auth checks, RBAC integration) are not just specific to authentication ‚Äî they're the architectural template for the entire codebase. This makes Epic 2 arguably the most important epic after the foundation.

### No Epic Updates Required

No significant discoveries were found that require changes to future epics. The patterns and decisions from Epic 2 have been validated by Epic 3 implementation.

---

## Next Steps

1. **Review this retrospective** ‚Äî ensure all insights are captured
2. **Address high-priority action items** (items 1-4)
3. **Continue Epic 3** ‚Äî nearly complete, retrospective pending
4. **Plan Epic 4 preparation** ‚Äî using the Epic 2 patterns for Participant Management

---

*Retrospective facilitated by BMAD workflow (re-run with Epic 3 hindsight)*
*Original: 2026-02-16 | Revised: 2026-02-19*
