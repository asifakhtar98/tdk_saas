# Story 1.2: Dependency Injection Configuration

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a **developer**,
I want **get_it and injectable configured for dependency injection**,
So that **all services and repositories can be automatically registered and resolved**.

## Acceptance Criteria

1. **Given** the project scaffold exists from Story 1.1, **When** I configure injectable with get_it, **Then** `lib/core/di/injection.dart` contains the injection container setup.

2. **Given** the DI configuration is in place, **When** I run `dart run build_runner build`, **Then** `lib/core/di/injection.config.dart` is generated by build_runner.

3. **Given** the DI container is configured, **When** I annotate a class with `@injectable`, `@lazySingleton`, or `@module`, **Then** the annotations work correctly and register the dependencies.

4. **Given** the project needs environment-specific configuration, **When** I configure environment annotations, **Then** `@dev`, `@staging`, and `@prod` environments are available.

5. **Given** the DI setup is complete, **When** I run `dart run build_runner build`, **Then** the command succeeds without errors.

6. **Given** the DI registration works, **When** I write unit tests, **Then** the tests verify that registered dependencies can be resolved.

## Tasks / Subtasks

- [x] **Task 1: Create DI Directory Structure (AC: #1)**
  - [x] Create `lib/core/di/` directory
  - [x] **DELETE** existing `lib/injection.config.dart` (generated file must be regenerated at new location)
  - [x] Move `lib/injection.dart` → `lib/core/di/injection.dart`
  - [x] Update all imports referencing the old location (check `bootstrap.dart`, `main_*.dart` files)
  - [x] Delete the old `lib/injection.dart` after confirming move is complete

- [x] **Task 2: Configure injectable with Proper Annotations (AC: #1, #3, #4)**
  - [x] Update `lib/core/di/injection.dart` with full @InjectableInit configuration
  - [x] Configure `asExtension: true`, `preferRelativeImports: true`
  - [x] Add environment annotation definitions

- [x] **Task 3: Create Environment Configuration Module (AC: #4)**
  - [x] Create `lib/core/di/environment.dart` with custom environment annotations
  - [x] Define `@dev`, `@staging`, `@prod` as custom Environment annotations

- [x] **Task 4: Create Register Module for Third-Party Dependencies (AC: #3)**
  - [x] Create `lib/core/di/register_module.dart`
  - [x] Register EnvironmentConfiguration as @module accessor
  - [x] Add placeholder for future third-party registrations (Supabase, etc.)

- [x] **Task 5: Update Bootstrap to Initialize DI (AC: #1, #5)**
  - [x] Update `lib/bootstrap.dart` to import from new location: `package:tkd_brackets/core/di/injection.dart`
  - [x] Change from `await configureDependencies()` to sync call `configureDependencies()` (see Dev Notes)
  - [x] Ensure DI initialization happens before runApp()
  - [x] Pass environment string correctly

- [x] **Task 6: Run Build Runner and Verify Generation (AC: #2, #5)**
  - [x] Run `dart run build_runner build --delete-conflicting-outputs`
  - [x] Verify `lib/core/di/injection.config.dart` is generated
  - [x] Verify no build errors occur

- [x] **Task 7: Create Sample Injectable Service for Verification (AC: #3)**
  - [x] Create `lib/core/services/logger_service.dart` with `@lazySingleton`
  - [x] Create simple logging interface that can be resolved

- [x] **Task 8: Write Unit Tests for DI Configuration (AC: #6)**
  - [x] Create `test/core/di/injection_test.dart`
  - [x] Test that GetIt container initializes without errors
  - [x] Test that registered services can be resolved
  - [x] Test environment-specific registration works

- [x] **Task 9: Update Analysis and Verify (AC: #5)**
  - [x] Run `dart analyze` with zero issues
  - [x] Run `flutter build web` successfully
  - [x] Run `flutter test` with all tests passing

## Dev Notes

### Project Location

**CRITICAL:** All code changes are in:
```
/Users/asak/Documents/dev/proj/personal/taekwondo_fix/tkd_brackets/
```

### Previous Story Learnings (Story 1.1)

From the completed Story 1.1 implementation:

| Learning                                                                    | Application to This Story                                       |
| --------------------------------------------------------------------------- | --------------------------------------------------------------- |
| Dependencies must be sorted alphabetically in pubspec.yaml                  | Any new dependencies must maintain sort order                   |
| Version conflicts occurred with bloc_test and flutter_form_builder          | If adding test dependencies, verify version compatibility first |
| The `injection.dart` file exists at `lib/injection.dart` with TODO comments | Must move to `lib/core/di/injection.dart` per architecture spec |
| `routing/` vs `router/` — architecture specifies `router/`                  | Similarly, ensure `di/` folder structure matches architecture   |
| Use `Implementation` not `Impl` in class names                              | Apply verbose naming in all new services                        |

### Current File State

The existing `lib/injection.dart` file contains:
```dart
import 'package:get_it/get_it.dart';
import 'package:injectable/injectable.dart';

// TODO(story-1.2): Uncomment after running build_runner.
// import 'package:tkd_brackets/injection.config.dart';

/// Global service locator instance.
final GetIt getIt = GetIt.instance;

/// Configures the dependency injection container.
/// Call this from bootstrap.dart before runApp().
@InjectableInit()
Future<void> configureDependencies(String environment) async {
  // TODO(story-1.2): Uncomment after running build_runner.
  // getIt.init(environment: environment);
}
```

This needs to be:
1. Moved to `lib/core/di/injection.dart`
2. Updated with proper configuration

### Required Architecture Patterns

**From Architecture Document [Source: architecture.md#Core-Architectural-Decisions]:**

```
Dependency Injection:
- `injectable` annotations: `@injectable`, `@lazySingleton`, `@module`
- `get_it` service locator underlying
- Generated via `injectable_generator`
```

**⚠️ Architecture Discrepancy Note:**
The architecture.md shows `injection.dart` at `lib/` root, but epics.md specifies `lib/core/di/injection.dart`. **Epics.md takes precedence** as the authoritative source for story requirements.

**File Location Pattern (per epics.md):**
```
lib/
├── core/
│   ├── di/
│   │   ├── injection.dart         # @InjectableInit configuration
│   │   ├── injection.config.dart  # Generated by build_runner
│   │   ├── environment.dart       # Custom environment annotations
│   │   └── register_module.dart   # @module for third-party deps
```

### Technical Requirements (MANDATORY)

**⚠️ CRITICAL: Async → Sync Pattern Change:**
The existing `lib/injection.dart` uses `Future<void> configureDependencies()` (async). The new implementation uses `void configureDependencies()` (sync). Update `bootstrap.dart` to remove `await` when calling.

**Injectable Setup Pattern (Latest API from context7):**

```dart
// lib/core/di/injection.dart
import 'package:get_it/get_it.dart';
import 'package:injectable/injectable.dart';
import 'package:tkd_brackets/core/di/injection.config.dart';

/// Global service locator instance.
final GetIt getIt = GetIt.instance;

/// Configures the dependency injection container.
/// Call this from bootstrap.dart before runApp().
@InjectableInit(
  initializerName: 'init',
  preferRelativeImports: true,
  asExtension: true,
)
void configureDependencies(String environment) => getIt.init(environment: environment);
```

**Environment Annotations Pattern:**

```dart
// lib/core/di/environment.dart
import 'package:injectable/injectable.dart';

/// Development environment.
const dev = Environment('development');

/// Staging environment.
const staging = Environment('staging');

/// Production environment.
const prod = Environment('production');
```

**Register Module Pattern:**

```dart
// lib/core/di/register_module.dart
import 'package:injectable/injectable.dart';

/// Module for registering third-party dependencies and configurations.
/// 
/// This is a placeholder module. Third-party dependencies (Supabase, Sentry, etc.)
/// will be added in their respective stories (1.6, 1.7).
@module
abstract class RegisterModule {
  // Placeholder for future third-party registrations:
  // - Supabase client (Story 1.6)
  // - Sentry service (Story 1.7)
  // - Other external services as needed
}
```

**Note:** EnvironmentConfiguration is already created in bootstrap.dart and passed as parameters. It doesn't need @module registration at this stage.

**Sample Injectable Service:**

```dart
// lib/core/services/logger_service.dart
import 'package:injectable/injectable.dart';

/// Logging service interface for centralized logging.
/// 
/// This is registered as a lazy singleton - instantiated on first use.
@lazySingleton
class LoggerService {
  /// Logs an informational message.
  void info(String message) {
    // TODO: Replace with proper logging in Story 1.7 (Sentry)
    // ignore: avoid_print
    print('[INFO] $message');
  }
  
  /// Logs a warning message.
  void warning(String message) {
    // ignore: avoid_print
    print('[WARNING] $message');
  }
  
  /// Logs an error message.
  void error(String message, [Object? error, StackTrace? stackTrace]) {
    // ignore: avoid_print
    print('[ERROR] $message');
    if (error != null) print(error);
    if (stackTrace != null) print(stackTrace);
  }
}
```

**Bootstrap Update:**

```dart
// lib/bootstrap.dart
import 'package:flutter/material.dart';
import 'package:tkd_brackets/app/app.dart';
import 'package:tkd_brackets/core/di/injection.dart';

/// Shared initialization for all flavors.
Future<void> bootstrap({
  required String environment,
  required String supabaseUrl,
  required String supabaseAnonKey,
}) async {
  WidgetsFlutterBinding.ensureInitialized();
  
  // Initialize DI container FIRST
  configureDependencies(environment);
  
  // TODO: Initialize Supabase (Story 1.6)
  // TODO: Initialize Sentry (Story 1.7)
  
  runApp(const App());
}
```

### Library/Framework Requirements

**Dependencies (Already in pubspec.yaml):**
- `get_it: ^8.0.3` - Service locator
- `injectable: ^2.5.0` - DI annotations

**Dev Dependencies (Already in pubspec.yaml):**
- `injectable_generator: ^2.6.3` - Code generator
- `build_runner: ^2.4.14` - Build system

**Build Configuration (Already in `build.yaml` — note: no leading dot):**
```yaml
targets:
  $default:
    builders:
      injectable_generator|injectable_builder:
        enabled: true
        generate_for:
          include:
            - lib/**
```

### File Structure Requirements

**Files to Create:**
```
lib/core/di/
├── injection.dart         # Main DI configuration
├── environment.dart       # Environment annotation definitions
└── register_module.dart   # @module for third-party dependencies

lib/core/services/
└── logger_service.dart    # Sample injectable service

test/core/di/
└── injection_test.dart    # DI unit tests
```

**Files to DELETE:**
- `lib/injection.dart` - DELETE after moving to core/di/
- `lib/injection.config.dart` - DELETE (will be regenerated at new location after build_runner)

**Files to Modify:**
- `lib/bootstrap.dart` - Update import path and change from async to sync call

### Testing Requirements

**Test Pattern:**

```dart
// test/core/di/injection_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:get_it/get_it.dart';
import 'package:tkd_brackets/core/di/injection.dart';
import 'package:tkd_brackets/core/services/logger_service.dart';

void main() {
  setUp(() {
    // Reset GetIt between tests
    GetIt.instance.reset();
  });

  tearDown(() {
    GetIt.instance.reset();
  });

  group('Dependency Injection Configuration', () {
    test('should initialize GetIt container without errors', () {
      // Act & Assert
      expect(
        () => configureDependencies('development'),
        returnsNormally,
      );
    });

    test('should resolve LoggerService after initialization', () {
      // Arrange
      configureDependencies('development');
      
      // Act
      final logger = getIt<LoggerService>();
      
      // Assert
      expect(logger, isA<LoggerService>());
    });

    test('should return same instance for lazy singletons', () {
      // Arrange
      configureDependencies('development');
      
      // Act
      final logger1 = getIt<LoggerService>();
      final logger2 = getIt<LoggerService>();
      
      // Assert
      expect(identical(logger1, logger2), isTrue);
    });
  });
}
```

### Anti-Patterns to AVOID

❌ **DO NOT** put injection.dart in lib/ root — it MUST be in lib/core/di/
❌ **DO NOT** use `@singleton` for services that need disposal — use `@lazySingleton`
❌ **DO NOT** register concrete implementations without interfaces for testability
❌ **DO NOT** forget to run build_runner after adding @injectable annotations
❌ **DO NOT** mix sync and async in configureDependencies() — injectable supports async, but keep it simple
❌ **DO NOT** import injection.config.dart before it's generated — build runner must run first

### Verification Commands

After all tasks complete, run these commands:

```bash
cd /Users/asak/Documents/dev/proj/personal/taekwondo_fix/tkd_brackets

# Generate DI code
dart run build_runner build --delete-conflicting-outputs

# Verify no analysis errors
dart analyze

# Run tests
flutter test

# Verify web build
flutter build web
```

### Project Structure Notes

- **Path Alignment:** The `lib/core/di/` structure aligns with the architecture document's specification
- **Import Changes:** All files importing `package:tkd_brackets/injection.dart` must be updated to `package:tkd_brackets/core/di/injection.dart`
- **Current State:** The project has Story 1.1 complete with the scaffold; this story builds on that foundation

### References

- [Source: architecture.md#Core-Architectural-Decisions] — DI with injectable + get_it specification
- [Source: architecture.md#Project-Structure-&-Boundaries] — Directory structure with injection.dart location
- [Source: architecture.md#Implementation-Patterns-&-Consistency-Rules] — Naming patterns for services
- [Source: epics.md#Story-1.2] — Acceptance criteria for this story
- [Source: 1-1-project-scaffold-and-clean-architecture-setup.md] — Previous story learnings and file locations
- [Source: injectable README (context7)] — Latest @InjectableInit configuration pattern

## Dev Agent Record

### Agent Model Used

Claude Sonnet (Gemini Antigravity Agent)

### Change Log

| Date       | Change                                                | Rationale                    |
| ---------- | ----------------------------------------------------- | ---------------------------- |
| 2026-02-01 | Implemented DI configuration with injectable + get_it | Story 1.2 implementation     |
| 2026-02-01 | Created LoggerService as sample @lazySingleton        | Verify DI registration works |
| 2026-02-01 | Added 9 unit tests for DI configuration               | Ensure DI correctness        |
| 2026-02-01 | Moved injection.dart to lib/core/di/ per architecture | Architecture compliance      |
| 2026-02-01 | [Code Review] Made @InjectableInit config explicit    | Technical requirements       |
| 2026-02-01 | [Code Review] Tests use environment constants         | Prevent hardcoded drift      |

### Completion Notes List

- ✅ DI container configured with get_it + injectable pattern
- ✅ @InjectableInit configured with extension pattern (asExtension: true is default)
- ✅ Environment annotations (@dev, @staging, @prod) created in environment.dart
- ✅ RegisterModule placeholder created for future third-party dependencies
- ✅ LoggerService created as sample @lazySingleton - verified it registers correctly
- ✅ Bootstrap updated to use sync configureDependencies() call
- ✅ Old injection.dart and injection.config.dart deleted from lib/ root
- ✅ Build runner generates injection.config.dart at new location
- ✅ All 9 unit tests pass (container init, service resolution, singleton behavior, environment tests)
- ✅ dart analyze: No issues found
- ✅ flutter test: All 9 tests passed
- ✅ flutter build web: Built successfully

### File List

**Created:**
- `lib/core/di/injection.dart` - Main DI configuration with @InjectableInit
- `lib/core/di/injection.config.dart` - Generated by build_runner *(gitignored - regenerated on build)*
- `lib/core/di/environment.dart` - Custom environment annotations
- `lib/core/di/register_module.dart` - Module for third-party registrations
- `lib/core/services/logger_service.dart` - Sample @lazySingleton service
- `test/core/di/injection_test.dart` - Unit tests for DI configuration

**Modified:**
- `lib/bootstrap.dart` - Updated import path, changed to sync configureDependencies() call

**Deleted:**
- `lib/injection.dart` - Moved to lib/core/di/
- `lib/injection.config.dart` - Regenerated at new location
